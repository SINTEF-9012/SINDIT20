version: '3.8'

services:
  graphdb:
    build:
      context: ./GraphDB
      dockerfile: ./Dockerfile
    ports:
      - "7200:7200"
    volumes:
      - data:/opt/graphdb/home  # Persist data between container restarts
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:7200/repositories | grep -E '^(200|401)$'"]
      interval: 5s  # Check every 30 seconds
      timeout: 5s  # Timeout for each check
      retries: 10  # Mark as unhealthy after 5 consecutive failures
      start_period: 5s  # Wait 10s before starting health checks

  sindit:
    build:
      context: .
      dockerfile: ./Dockerfile
    env_file:
      - environment_and_configuration/docker_environment_backend.env  # Load environment variables from this file
    depends_on:
      graphdb:
        condition: service_healthy  # Wait for GraphDB to be healthy before starting backend
    ports:
      - "9017:9017"
volumes:
  data: 